<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
 * SESSION_INFO
 * ID							ID						BIGINT						PRIMARY KEY
 * 用户ID						USER_ID					BIGINT						PRIMARY KEY
 * 最后消息ID						LATEST_MESSAGE_ID		BIGINT
 * 创建时间						CREATE_TIME				TIMESTAMP					DEFAULT NOW()
 -->
<mapper namespace="com.hanslv.web.chat.mapper.SessionInfoMapper">
    <!-- 获取全部 -->
    <select id="selectAll" resultType="com.hanslv.web.chat.entity.SessionInfoEntity">
        SELECT * FROM SESSION_INFO;
    </select>

    <!-- 根据双方用户ID查询会话 -->
    <select id="selectByUserId" resultType="com.hanslv.web.chat.entity.SessionInfoEntity">
        SELECT
            a.ID AS id,
            a.USER_ID AS userId,
            a.LATEST_MESSAGE_ID AS latestMessageId,
            a.CREATE_TIME AS createTime
        FROM SESSION_INFO a INNER JOIN SESSION_INFO b ON a.ID = b.ID
        WHERE a.USER_ID = #{userId} AND b.USER_ID = #{otherUserId};
    </select>

    <!-- 获取最大SessionID -->
    <select id="selectMaxSessionId" resultType="int">
        SELECT MAX(ID) FROM SESSION_INFO;
    </select>

    <!-- 插入一条包含ID的记录 -->
    <insert id="insertOne">
        INSERT INTO SESSION_INFO (ID, USER_ID, LATEST_MESSAGE_ID) VALUES (#{id}, #{userId}, #{latestMessageId});
    </insert>

    <!-- 更新最后一条消息ID -->
    <update id="updateSessionMessageId">
        UPDATE SESSION_INFO SET LATEST_MESSAGE_ID = #{messageId} WHERE ID = #{sessionId} AND USER_ID = #{userId}
    </update>
</mapper>